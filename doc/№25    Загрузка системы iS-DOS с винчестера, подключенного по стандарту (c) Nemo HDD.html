
<!-- saved from url=(0038)http://abzac.retropc.ru/content?id=420 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">

<meta name="keywords" content="Абзац,новости,Perspective,Axor,Spectrum,ZX,Speccy,газета,Спекки,Спектрум,Синклер,Scorpion,Pentagon,KAY">
<meta name="description" content="Газета Абзац, новости о ZX-Spectrum">
<title>    №25 :: Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD
    </title>
<link rel="shortcut icon" href="http://abzac.retropc.ru/img/favicon.png" type="image/png">
<link rel="stylesheet" type="text/css" href="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/style.css">
</head>

<body>

<table cellspacing="0" cellpadding="0" style="width: 100%; margin-top: 10px; border: none;"><tbody><tr><td style="text-align: left; vertical-align: bottom; width: 210px; background-image:url(&#39;../img/sh21.gif&#39;); background-repeat:no-repeat; background-position:top right;"><div class="menu2"><div><a href="http://abzac.retropc.ru/ti">Конкурс «Твоя игра»</a></div><div><a href="http://vera.retropc.ru/">Игра «Вера»</a></div></div></td><td style="text-align: center; background-image:url(&#39;../img/sh22.gif&#39;); background-repeat:repeat-x;"><a href="http://abzac.retropc.ru/"><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/sh20.png" alt="Абзац" border="0" height="128" width="430"></a></td><td style="text-align: right; vertical-align: bottom; width: 210px; background-image:url(&#39;../img/sh23.gif&#39;); background-repeat:no-repeat; background-position:top left;"><div class="menu"><div><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/menu_square.gif"><a href="http://abzac.retropc.ru/about">О газете</a></div><div><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/menu_square.gif"><a href="http://abzac.retropc.ru/toc">Содержание</a></div><div><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/menu_square.gif"><a href="http://abzac.retropc.ru/download">Скачать</a></div><div><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/menu_square.gif"><a href="http://abzac.retropc.ru/contact">Контакты</a></div></div></td></tr></tbody></table>

<table class="block"><tbody><tr>
	<td class="left">
    	<div class="box">
	<div class="boxlabel">:: СОДЕРЖАНИЕ НОМЕРА</div>
	<div class="inbox">
		<div style="text-align:center; padding: 1em 0;">
			<img style="padding: 2px; border: 1px solid #888;" src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/a25_tmb160.jpg">
		</div>
				    <p><a href="http://abzac.retropc.ru/content?id=256">Новости. </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=257">Новости с "мягкого фронта". </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=417"> Chaos Construction 2005. Перспективы. </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=418"> Почему нет нового железа или Исповедь производителя. </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=419"> Особенности программирования CD-ROM на Спектруме.</a></p>
				    <p><a href="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD.html"> Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD.</a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=421"> Подключение IBM-периферии к ZX Spectrum. Клавиатура. </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=422"> Этюды. </a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=423"> Частные объявления.</a></p>
				    <p><a href="http://abzac.retropc.ru/content?id=424"> Колонка редактора.</a></p>
			</div>
</div>        <div class="box">
	<div class="boxlabel">:: Газетные рЈбрИки</div>

	<div class="inbox">
        	<p><a href="http://abzac.retropc.ru/list?r=0">Без рубрики</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=4">В помощь разработчику</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=2">Железо</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=6">Интервью</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=15">Легенды о себе</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=8">Мысли вслух</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=10">Новости</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=5">Обратная связь</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=1">Проекты</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=7">События</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=14">Сценарий</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=17">Тайники</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=3">Читатель читателю</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=16">Это интересно</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=9">Этюды</a></p>
        	<p><a href="http://abzac.retropc.ru/list?r=12">Юмор</a></p>
        </div>


</div>
        <div class="box">
	<div class="boxlabel">:: АВТОРЫ</div>
	<div class="inbox">
					<a href="http://abzac.retropc.ru/list?a=79"><p>Александр Синяков</p></a>
					<a href="http://abzac.retropc.ru/list?a=59"><p>Дмитрий Быстров</p></a>
					<a href="http://abzac.retropc.ru/list?a=85"><p>Олег Голенков</p></a>
					<a href="http://abzac.retropc.ru/list?a=88"><p>Вячеслав Савенков</p></a>
					<a href="http://abzac.retropc.ru/list?a=89"><p>mackerel</p></a>
					<a href="http://abzac.retropc.ru/list?a=74"><p>Андрей Баглай</p></a>
					<a href="http://abzac.retropc.ru/list?a=84"><p>Kendo Anoubis</p></a>
					<a href="http://abzac.retropc.ru/list?a=87"><p>Вадим Акимов</p></a>
					<a href="http://abzac.retropc.ru/list?a=86"><p>Андрей Пикало</p></a>
					<a href="http://abzac.retropc.ru/list?a=1"><p>Александр Шушков</p></a>
				<br>
		<p><a href="http://abzac.retropc.ru/authors"><b>Все авторы</b></a></p>
	</div>
</div>     
        <div class="box">
	<div class="boxlabel">:: Поиск</div>

	<div class="inbox" style="margin-top: 0.3em;">  
    	<div class="search">
        	<form method="get" id="searchbox_form" action="http://abzac.retropc.ru/search">
        		<div id="find_button"><img src="./№25    Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD_files/mail_find.png" title="Искать" width="32" height="32"></div>
            	<input name="q" maxlength="48" type="text">
            	<div style="clear: both;"></div>
			</form>
		</div>
	</div>
	

</div>
        <div class="box">
	<div class="boxlabel">:: ПоддерЖка ПрОекта</div>

	<div class="inbox">  
		<b>Webmoney:</b>
		<li>Z610389805629</li>
		<li>R427996570517</li>
		<li>E023541002978</li>
	</div>
	

</div>    

			</td>
	<td class="center">
		<div class="box">
	<div class="boxlabel">::     №25 (09.09.2005) <span class="Comment">ПрОсмотрОв: 5216</span>
    </div>

	<div class="inbox">    <p></p><div class="inbox"><p><b>Автор: </b> <a href="http://abzac.retropc.ru/list?a=57" title="Все статьи автора">Сергей Баган</a>.</p><p><b>Рубрика: </b> <a href="http://abzac.retropc.ru/list?r=3" title="Все статьи в рубрике">Читатель читателю</a>.</p><p><b>Номер: </b> <a href="http://abzac.retropc.ru/toc?n=25" title="Все статьи номера">№25 (09.09.2005)</a>.</p><hr><br><h3>Загрузка системы iS-DOS с винчестера, подключенного по стандарту (c) Nemo HDD</h3>Для того чтобы понять принцип загрузки системы и ее запуска сначала надо разобраться в строении самой системы. Начнем с системы iS-DOS Classic.<p></p><br><p>Пример распределения памяти в is-dos Classic</p><div class="codebox"><div class="incqbox"><div class="scrollbox"><pre>0       ПЗУ BASIC-48

16384   экран      
23296   программа exebat.com       
23552   системные переменные       
23900   программа mon.com (menu.com)       
24000   область com-файлов     
36000   кэш    
43000   каналы     
44000   резиденты и драйверы       
50304   уровень 4 SHELL    
54800   уровень 3 WIN      
58472   уровень 2 COM      
60726   уровень 1 DUD      
63296   уровень 0 DOS</pre></div></div></div><p>Посмотрим, что же из памяти компьютера надо сохранять, чтобы потом можно было загрузить систему.</p><p>Область для программы exebat.com в сохранении не нуждается, поскольку эта программа и так загружается каждый раз при запуске bat-файлов.</p><p>Нам потребуются системные переменные TR-DOS, а также область каналов Бейсика, т.к. там хранится адрес обработчика RST #10 для 4-го канала, через который вызываются все рестарты iS-DOS. Системные переменные TR-DOS нужны для работы с дискетой.</p><p>Область памяти для программ mon.com и menu.com можно не сохранять по той же причине, что и для программы exebat.com.</p><p>Область для com-файлов сохранять не нужно.</p><p>Кэш сохранять не требуется, т.к. он и без того заново пересоздается при запуске системы.</p><p>Остается область каналов и все, что выше. Вот эту область памяти необходимо обязательно сохранять. При этом остаются все ранее установленные драйверы и резиденты, а также там находится само ядро системы (уровни 4-0). Кроме того, нам необходимы каналы устройств. Именно так и работает программа sv.com. Кроме того, в этой области памяти находится обработчик прерываний режима IM 2. Таким образом, нам необходимо сохранить область системных переменных (о ней расскажем чуть позже) и ядро системы со всеми резидентами, драйверами и каналами (в файл is_dos.sys или *_dos.sys).</p><p>Теперь посмотрим, как распределена память в iS-DOS Chic</p><br><p>Пример распределения памяти в is-dos Chic</p><div class="codebox"><div class="incqbox"><div class="scrollbox"><pre>#0010   RST #10    
#003B   подпрограмма драйвера электронного диска       
#0047   признак типа системы/компьютера    
#0069   таблица для драйвера электронного диска    
#0101   буфер для драйвера электронного диска      
#0201   знакогенератор t64 (1K)    
#0601   не используется    
#093A   ядро системы (неизменяемая часть)       
#3800   знакогенератор t42 (2K)    
#4000   экран      
#5B00   программа exebat.com       
#5C00   системные переменные       
#5D5C   программа mon.com (menu.com)       
#5DC0   область com-файлов     
#A5A2   кэш (49 блоков)    
#D6F0   каналы     
#DAD8   резиденты и драйверы

изменяемая часть               

#F365   уровень 4: SHELL    
#F78C   уровень 3: WIN         
#FA88   уровень 2: COM         
#FC0C   уровень 1: DUD         
#FDE6   уровень 0: DOS</pre></div></div></div><p>Как видим, система состоит из двух частей - изменяемой и неизменяемой. Неизменяемая часть расположена в нижней странице памяти (раздел CPU0, адреса #0000-#3FFF). Изменяемая часть расположена в адресах #4000-#FFFF.</p><p>Неизменяемая часть один раз создается и записывается в файл is_dos.rom. В дальнейшей работе ее не потребуется заменять, она только загружается.</p><p>А изменяемая часть с учетом предыдущего пункта (iS-DOS Classic) сохраняется с области каналов до конца памяти. Также сохраняется область системных переменных.</p><p>Допустим, что файлы с системой сохранены на диске программой sv.com. Однако как его загрузить, если не знаем, где он расположен? У нас есть только один винчестер и больше ничего. Следовательно, нам надо ввести привязку месторасположения файла is_dos.sys к чему-нибудь, а именно к 0-му блоку устройства, где располагается файл is_dos.sys. Для введения такой привязки служит программа con.com. Она сохраняет описатель файла is_dos.sys в 0-м блоке текущего устройства по смещению +32 dec. Заодно она считает контрольную сумму этого самого описателя и сохраняет ее в том же самом блоке по смещению +27 dec. Теперь загрузив 0-й блок устройства можно узнать, где располагается файл is_dos.sys с сохраненной системой.</p><p>Это решает только часть проблем. Откуда мы узнаем, где именно на винчестере располагается нужное нам устройство и вообще нем неизвестна конфигурация винчестера (количество головок, секторов и цилиндров). Можно было бы изначально в программу-загрузчик ввести конфигурацию винчестера, но она в таком случае окажется неуниверсальной, рассчитанной только под один тип винчестера.</p><p>Тут все делается просто. Дело в том, что можно загрузить 0-й блок любого устройства, не зная конфигурации винчестера вообще. Такой блок будет располагаться на 1-м секторе и 0-й головке одного из треков винчестера. А 1-й сектор и 0-я головка есть у любого винчестера. Следовательно, нам надо только перебрать все треки винчестера и читать на них сектор 1 при выбранной головке 0 (нумерация секторов начинается с 1, головок с 0, треков с 0). Но устройств на винчестере может быть несколько, и неизвестно, какое из них было использовано как загрузочное. Для этого 0-й блок загрузочного устройства помечают особым образом, чтобы программа, сканирующая винчестер, сразу узнала, что это то устройство, которое нам надо.</p><p>Стандартной программой для подключения системы для ее последующей загрузки с винчестера является программа uni_con.com. Она записывает в 0-й блок текущего устройства идентификатор «KAY» по смещению +127 dec. Именно по наличию такого идентификатора программа загрузчик определяет, что с данного устройства нужно загружать систему. Из этого следует, что загрузочное устройство на винчестере может быть только одно...</p><p>До этого мы говорили про сохранение и загрузку ядра системы с набором драйверов и резидентов, расположенного в файле is_dos.sys. С этим все более-менее ясно. А вот как же поступить с системными переменными? Их тоже надо куда-то сохранять - без них запустить систему невозможно. В данном случае они сохраняются в отдельном файле, а именно совмещены с непосредственным загрузчиком системы. Сама загрузка и запуск системы с винчестера осуществляются в два этапа: предварительная загрузка с последующим определением параметров винчестера, затем загрузка непосредственно самой системы и ее запуск.</p><p>Чтобы сохранить систему на винчестере и подключить ее для последующей загрузки нам потребуются: </p><p>1) программа sv.com для сохранения системы в файле на винчестере;</p><p>2) программа uni_con.com, которая подключает все нужные файлы к 0-му блоку устройства;</p><p>3) файл is_dos.rom, в котором хранится неизменяемая часть системы iS-DOS Chic (для подключения системы iS-DOS Classic требуется лишь формально);</p><p>4) загрузчик системы с винчестера uni_clas.sys (или uni_chic.sys для iS-DOS Chic), в дальнейшем переименовывается в файл uni_boot.sys;</p><p>5) загрузчик системы, который вызывается на исполнение из ПЗУ при включении компьютера. В компьютере KAY-1024 это hdd_boot, прошитый в ПЗУ. Его можно вызвать на выполнение при выборе соответствующего пункта меню. Для других компьютеров запуск системы возможен только в случае прошивки загрузчика в ПЗУ или если его предварительно загрузить с диска. Для системы iS-DOS Chic файлы is_dos.rom и is_dos.sys должны быть предварительно настроены под нужный тип компьютера (KAY, Profi, Scorpion и т.д.). Процесс настройки в данной статье не приводится. Он приведен в текстовых файлах на диске с базовым комплектом iS-DOS Chic.</p><p>Порядок действий следующий:</p><p>Сначала выбираем устройство, на котором будем сохранять систему, и с которого будем в последующем ее загружать. Единственное ограничение - номер трека устройства не должен быть более 255. Дело в том, что при сканировании винчестера программа перебирает треки 0-255. Чтобы узнать номер трека, на котором расположено устройство, нужно запустить программу ide_tune.com для текущего драйвера винчестера.</p><p>На выбранном устройстве создается для удобства какой-нибудь каталог, куда копируются файлы: uni_con.com, is_dos.rom, uni_boot.sys (файл uni_clas.sys или uni_chic.sys переименовываются в зависимости от типа системы, которая подключается).</p><p>Если подключается система iS-DOS Classic файл is_dos.rom должен присутствовать формально. То есть необязательно брать файл от системы iS-DOS Chic длиной 64 сектора, а просто создать, к примеру, в текстовом редакторе файл с таким же названием и любой длины. Этот файл требуется только при подключении iS-DOS Chic, но так как программа uni_con.com является универсальной, она проверяет наличие файла is_dos.rom в каталоге. Кстати, после загрузки системы с винчестера, этот файл можно будет удалить.</p><p>В системе надо устройство S переключить на то устройство, где мы будем сохранять систему. Это делается потому, что программа uni_con.com подключает систему именно на устройство S. Система уже должна быть настроена (установлены необходимые драйвера и резиденты, установлен размер кэша). Затем система сохраняется программой sv.com в каталог, куда мы копировали файлы. Кстати, обязательно должен быть установлен резидент calc.res, иначе при работе программы uni_con.com будет ошибка.</p><p>Наконец, запускается программа uni_con.com, которая проверяет все файлы и подключает к 0-му блоку устройства. После нормального завершения работы программы система станет загружаться с винчестера.</p><p>Теперь рассмотрим подробно, что же делает программа uni_con.com. </p><p>1) проверяется присутствие файлов is_dos.sys, is_dos.rom и uni_boot.sys в том же каталоге; </p><p>2) сохраняются в 0-м блоке контрольные суммы файлов is_dos.sys и is_dos.rom и сами описатели; </p><p>3) сохраняется признак загрузочного устройства «KAY» в 0-м блоке;</p><p>4) по номеру текущего устройства определяется драйвер устройства, и если это драйвер винчестера, то конфигурация винчестера из драйвера записывается в 0-й блок устройства; </p><p>5) системные переменные системы (с #5C00 длиной 512 байт) сохраняются в файл uni_boot.sys;</p><p>6) подсчитывается контрольная сумма файла uni_boot.sys (он ведь был изменен);</p><p>7) файл uni_boot.sys защищается от удаления, чтения и записи. Это для того, чтобы программа arzt+.com не передвинула этот файл куда-нибудь или чтобы его случайно не удалили. Очень важно, чтобы этот файл оставался на одном и том же месте - ведь на его расположение есть ссылка в 0-м блоке устройства. Кстати, с файлом is_dos.sys этого не делается, потому что arzt+.com сама отслеживает изменение месторасположения этого файла и изменяет 0-й блок устройства.</p><br><p>Теперь посмотрим, что же система сохраняет в 0-м блоке устройства:</p><div class="codebox"><div class="incqbox"><div class="scrollbox"><pre>Байт Длина Описание

 27   1     Контрольная сумма описателя is_dos.sys     
 28   2     Байты 8 и 7 из вектора конфигурации системы. Назначение их неизвестно.     
 32  32     Описатель is_dos.sys       
 64  32     Описатель is_dos.rom       
 96   1     Контрольная сумма описателя is_dos.rom     
 97  24     Часть драйвера винчестера, где находится информация о структуре винчестера и его характеристиках       
125   3     Признак "KAY"      
128  32     Описатель uni_boot.sys</pre></div></div></div><p>Осуществляется при вызове загрузчика hdd_boot из ПЗУ компьютера. Как уже упоминалось выше, без знания параметров винчестера можно загрузить с любого трека 1-й сектор с 0-й головкой. Последовательно перебираются 1-е сектора на каждом треке с 0 по 255. Если все треки перебраны, то программа «виснет». Ограничение количества треков числом 255 обусловлено использованием одного байта для счетчика треков. Конечно, можно было ввести два байта для счетчика треков, однако представьте себе, что будут перебираться несколько сот треков на винчестере. Времени это займет очень много.</p><p>Если на считанном блоке обнаруживается признак загрузочного устройства «KAY», то из этого блока берется конфигурация винчестера и заносится в загрузчик. Теперь, зная конфигурацию винчестера, можно уже читать любое количество информации с него. Теперь можно взять информацию о непосредственном загрузчике системы uni_boot.sys, программа загружает его в память и запускает на выполнение.</p><p>Теперь начинается загрузка непосредственно самой системы. Кстати, 0-й блок уже загружен в память программой hdd_boot. Процессы загрузки iS-DOS Classic и Chic несколько различаются.</p><p>Программа uni_boot.sys (для системы Classic) делает следующее:</p><p>1) берет из 0-го блока информацию о файле is_dos.sys и загружает его в память (предварительно устанавливается 0-я банка памяти).</p><p>2) устанавливается вектор прерывания системы из 0-го блока (находится в описателе файла is_dos.sys по смещению +22 dec);</p><p>3) системные переменные (занесенные в файл uni_boot.sys программой uni_con.com) переносятся из тела программы в память по адресу #5C00;</p><p>4) система уже в памяти, системные переменные перенесены, становится доступно обращение к рестартам системы через RST #10, поэтому определяем размер электронного диска в блоках и создаем сам электронный диск (кэш);</p><p>5) дата из 0-го блока переносится в систему;</p><p>6) переключаемся на устройство «S», с которого и сохранялись;</p><p>7) выходим в систему с запуском autoexec.bat.</p><p>Для загрузки iS-DOS Chic процесс загрузки несколько меняется:</p><p>1) Устанавливаем банк 8 памяти в раздел CPU3, в раздел CPU0 включается банк 0 ОЗУ. Кстати, для KAY и PROFI загрузчики должны быть разные, т.к. в KAY используется порт #1FFD, а в PROFI - порт #DFFD.</p><p>2) Берем информацию о файле is_dos.rom и загружаем файл в под-ПЗУшную область;</p><p>3) берет из 0-го блока информацию о файле is_dos.sys и загружает его в память (предварительно устанавливается 0-я банка памяти).</p><p>4) устанавливается вектор прерывания системы из 0-го блока (находится в описателе файла is_dos.sys по смещению +22 dec);</p><p>5) системные переменные (занесенные в файл uni_boot.sys программой uni_con.com) переносятся из тела программы в память по адресу #5C00;</p><p>6) система уже в памяти, системные переменные перенесены, становится доступно обращение к рестартам системы через RST #10, поэтому определяем размер электронного диска в блоках и создаем сам электронный диск (кэш);</p><p>7) дата из 0-го блока переносится в систему;</p><p>8) переключаемся на устройство «S», с которого и сохранялись;</p><p>9) выходим в систему с запуском autoexec.bat.</p><br><p>* * *</p><p>При написании статьи использованы материалы по iS-DOS, опубликованные в электронном издании ZX-Format 5, описания рестартов системы из приложения к диску с iS-Assembler, а также исходные тексты программ uni_con.com, uni_clas.sys, uni_chic.sys, hdd_boot.com.</p><br><p><b>P.S.</b> Тем, кто желает ознакомиться с полной версией статьи следует заказать себе сборник «iS-files» № 3, № 4, где данная статья опубликована со всеми приложениями.<br><br></p></div><p></p>
</div>


</div>
		
			
	</td>
	</tr></tbody></table>

<div style="clear: both;"></div>
<div class="block1col">
    <div class="block">
        <div class="box">
            <div class="inbox">
                © 2004-2013 <a href="mailto:axor@mail.ru">Perspective group</a>
                            </div>
        </div>
    </div>
</div>


</body></html>